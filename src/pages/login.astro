---
import Layout from "@/layouts/Layout.astro";
---

<Layout title="Login - Sabor del Campo" showUserInfo={false}>
  <!-- Contenido Principal -->
  <div class="mx-auto mt-16 max-w-md p-6">
    <div class="rounded-xl bg-white p-8 shadow-lg">
      <div class="mb-8 text-center">
        <div class="mb-4 text-6xl">游댏</div>
        <h2 class="mb-2 text-3xl font-bold text-gray-800">Iniciar Sesi칩n</h2>
        <p class="text-gray-600">Accede a la gesti칩n de productos</p>
      </div>

      <!-- Formulario de Login -->
      <form id="loginForm" class="space-y-6">
        <div>
          <label
            for="username"
            class="mb-2 block text-sm font-medium text-gray-700"
          >
            Usuario
          </label>
          <input
            type="text"
            id="username"
            name="username"
            required
            class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:border-transparent focus:ring-2 focus:ring-green-500"
            placeholder="Ingresa tu usuario"
          />
        </div>

        <div>
          <label
            for="password"
            class="mb-2 block text-sm font-medium text-gray-700"
          >
            Contrase침a
          </label>
          <input
            type="password"
            id="password"
            name="password"
            required
            class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:border-transparent focus:ring-2 focus:ring-green-500"
            placeholder="Ingresa tu contrase침a"
          />
        </div>

        <button
          type="submit"
          class="w-full rounded-lg bg-green-600 px-4 py-3 font-medium text-white transition-colors hover:bg-green-700"
        >
          Iniciar Sesi칩n
        </button>
      </form>

      <!-- Mensaje de Error -->
      <div
        id="errorMessage"
        class="mt-4 hidden rounded-lg border border-red-400 bg-red-100 p-3 text-red-700"
      >
        Usuario o contrase침a incorrectos
      </div>

      <!-- Informaci칩n de Credenciales -->
      <div class="mt-8 rounded-lg border border-blue-200 bg-blue-50 p-4">
        <h3 class="mb-2 font-semibold text-blue-800">
          Credenciales de prueba:
        </h3>
        <p class="text-sm text-blue-700">
          <strong>Usuario:</strong> admin<br />
          <strong>Contrase침a:</strong> admin123
        </p>
      </div>
    </div>
  </div>
</Layout>

<script>
  import AuthService from "@/services/authService.js";

  // Referencias a elementos del DOM
  const loginForm = document.getElementById("loginForm");
  const errorMessage = document.getElementById("errorMessage");

  // Verificar si ya est치 logueado al cargar la p치gina
  function checkAuthStatus() {
    if (AuthService.isAuthenticated()) {
      // Redirigir a productos si ya est치 logueado
      window.location.href = "/productos";
    }
  }

  // Manejar env칤o del formulario
  loginForm.addEventListener("submit", async function (e) {
    e.preventDefault();

    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value;

    try {
      // Usar el servicio de autenticaci칩n
      const result = await AuthService.login(username, password);

      if (result.success) {
        // Login exitoso - redirigir a productos
        window.location.href = "/productos";
      } else {
        // Mostrar error
        errorMessage.textContent = result.message;
        errorMessage.classList.remove("hidden");

        // Limpiar campo de contrase침a
        document.getElementById("password").value = "";

        // Ocultar error despu칠s de 3 segundos
        setTimeout(() => {
          errorMessage.classList.add("hidden");
        }, 3000);
      }
    } catch (error) {
      // Error inesperado
      errorMessage.textContent = "Error inesperado. Intente nuevamente.";
      errorMessage.classList.remove("hidden");

      setTimeout(() => {
        errorMessage.classList.add("hidden");
      }, 3000);
    }
  });

  // Verificar estado al cargar la p치gina
  checkAuthStatus();

  // Limpiar error al escribir
  document.getElementById("username").addEventListener("input", () => {
    errorMessage.classList.add("hidden");
  });

  document.getElementById("password").addEventListener("input", () => {
    errorMessage.classList.add("hidden");
  });
</script>
